<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öôÔ∏è Qu·∫£n L√Ω L√¨ X√¨ - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* =====================================================
       ADMIN STYLE - Giao di·ªán qu·∫£n l√Ω m·ªánh gi√° l√¨ x√¨
       Thi·∫øt k·∫ø t·ªëi gi·∫£n, d·ªÖ s·ª≠ d·ª•ng
       ===================================================== */
    
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Be Vietnam Pro', sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .admin-container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Header Admin */
    .admin-header {
      text-align: center;
      padding: 20px 0 30px;
    }

    .admin-header h1 {
      font-size: 2em;
      color: #FFD700;
      margin-bottom: 5px;
    }

    .admin-header p {
      color: rgba(255,255,255,0.6);
    }

    .admin-header a {
      color: #FFD700;
      text-decoration: none;
    }

    /* Th·ªëng k√™ t·ªïng quan */
    .thong-ke-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(255,215,0,0.2);
    }

    .stat-card .so {
      font-size: 2em;
      color: #FFD700;
      font-weight: 700;
    }

    .stat-card .nhan {
      font-size: 0.85em;
      color: rgba(255,255,255,0.6);
      margin-top: 5px;
    }

    /* Form th√™m m·ªánh gi√° */
    .form-section {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255,215,0,0.2);
    }

    .form-section h2 {
      color: #FFD700;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 150px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9em;
      color: rgba(255,255,255,0.7);
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255,215,0,0.3);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 1em;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      border-color: #FFD700;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.2s;
    }

    .btn-them {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #1a1a2e;
      align-self: flex-end;
    }

    .btn-them:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255,215,0,0.3);
    }

    .btn-xoa {
      background: #ff4444;
      color: #fff;
      padding: 6px 15px;
      font-size: 0.85em;
    }

    .btn-xoa:hover {
      background: #cc0000;
    }

    .btn-sua {
      background: #4CAF50;
      color: #fff;
      padding: 6px 15px;
      font-size: 0.85em;
    }

    .btn-sua:hover {
      background: #388E3C;
    }

    /* B·∫£ng danh s√°ch m·ªánh gi√° */
    .bang-section {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(255,215,0,0.2);
      margin-bottom: 25px;
    }

    .bang-section h2 {
      color: #FFD700;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: rgba(255,215,0,0.15);
      color: #FFD700;
      padding: 12px 15px;
      text-align: left;
      font-size: 0.9em;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.95em;
    }

    tr:hover td {
      background: rgba(255,255,255,0.03);
    }

    .menh-gia-cell {
      color: #FFD700;
      font-weight: 700;
    }

    /* Th√¥ng b√°o */
    .thong-bao {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 12px;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .thong-bao.thanh-cong {
      background: #4CAF50;
      color: #fff;
    }

    .thong-bao.that-bai {
      background: #ff4444;
      color: #fff;
    }

    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Quick add buttons */
    .quick-add {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .quick-add-btn {
      padding: 8px 15px;
      border-radius: 8px;
      border: 1px solid rgba(255,215,0,0.3);
      background: rgba(255,215,0,0.1);
      color: #FFD700;
      cursor: pointer;
      font-size: 0.85em;
      font-family: inherit;
      transition: all 0.2s;
    }

    .quick-add-btn:hover {
      background: rgba(255,215,0,0.25);
      border-color: #FFD700;
    }

    /* L·ªãch s·ª≠ section */
    .lich-su-admin {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(255,215,0,0.2);
    }

    .lich-su-admin h2 {
      color: #FFD700;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .thong-ke-cards { grid-template-columns: 1fr; }
      .form-row { flex-direction: column; }
      th, td { padding: 8px 10px; font-size: 0.85em; }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
      <h1>‚öôÔ∏è Qu·∫£n L√Ω L√¨ X√¨</h1>
      <p>Th√™m, x√≥a, s·ª≠a m·ªánh gi√° ti·ªÅn l√¨ x√¨ | <a href="/">üè† V·ªÅ trang ch√≠nh</a></p>
    </div>

    <!-- ============================================= -->
    <!-- TH·ªêNG K√ä T·ªîNG QUAN                           -->
    <!-- ============================================= -->
    <div class="thong-ke-cards">
      <div class="stat-card">
        <div class="so" id="stat-menh-gia">---</div>
        <div class="nhan">Lo·∫°i m·ªánh gi√°</div>
      </div>
      <div class="stat-card">
        <div class="so" id="stat-phong-bi">---</div>
        <div class="nhan">T·ªïng phong b√¨</div>
      </div>
      <div class="stat-card">
        <div class="so" id="stat-tong-tien">---</div>
        <div class="nhan">T·ªïng ti·ªÅn (VNƒê)</div>
      </div>
    </div>

    <!-- ============================================= -->
    <!-- FORM TH√äM M·ªÜNH GI√Å M·ªöI                      -->
    <!-- ============================================= -->
    <div class="form-section">
      <h2>‚ûï Th√™m M·ªánh Gi√° M·ªõi</h2>
      <div class="form-row">
        <div class="form-group">
          <label>üí∞ M·ªánh gi√° (VNƒê)</label>
          <input type="number" id="input-menh-gia" placeholder="VD: 10000" min="0">
        </div>
        <div class="form-group">
          <label>üì¶ S·ªë l∆∞·ª£ng phong b√¨</label>
          <input type="number" id="input-so-luong" placeholder="VD: 5" min="1" value="1">
        </div>
        <button class="btn btn-them" onclick="themMenhGia()">‚ûï Th√™m</button>
      </div>

      <!-- N√∫t th√™m nhanh c√°c m·ªánh gi√° ph·ªï bi·∫øn -->
      <div class="quick-add">
        <span style="color:rgba(255,255,255,0.5); font-size:0.85em; align-self:center;">Th√™m nhanh:</span>
        <button class="quick-add-btn" onclick="themNhanh(0, 50)">0ƒë √ó50</button>
        <button class="quick-add-btn" onclick="themNhanh(100, 30)">100ƒë √ó30</button>
        <button class="quick-add-btn" onclick="themNhanh(200, 30)">200ƒë √ó30</button>
        <button class="quick-add-btn" onclick="themNhanh(500, 20)">500ƒë √ó20</button>
        <button class="quick-add-btn" onclick="themNhanh(1000, 15)">1.000ƒë √ó15</button>
        <button class="quick-add-btn" onclick="themNhanh(5000, 5)">5.000ƒë √ó5</button>
        <button class="quick-add-btn" onclick="themNhanh(10000, 3)">10.000ƒë √ó3</button>
        <button class="quick-add-btn" onclick="themNhanh(50000, 1)">50.000ƒë √ó1</button>
        <button class="quick-add-btn" onclick="themNhanh(100000, 1)">100.000ƒë √ó1</button>
        <button class="quick-add-btn" onclick="themNhanh(500000, 1)">500.000ƒë √ó1</button>
      </div>
    </div>

    <!-- ============================================= -->
    <!-- B·∫¢NG DANH S√ÅCH M·ªÜNH GI√Å                     -->
    <!-- ============================================= -->
    <div class="bang-section">
      <h2>üìã Danh S√°ch M·ªánh Gi√°</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>üí∞ M·ªánh Gi√°</th>
            <th>üì¶ S·ªë L∆∞·ª£ng</th>
            <th>üìÖ Ng√†y T·∫°o</th>
            <th>üéØ T·ª∑ L·ªá</th>
            <th>‚öôÔ∏è Thao T√°c</th>
          </tr>
        </thead>
        <tbody id="bang-menh-gia">
          <!-- S·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- ============================================= -->
    <!-- L·ªäCH S·ª¨ R√öT L√å X√å                           -->
    <!-- ============================================= -->
    <div class="lich-su-admin">
      <h2>üìú L·ªãch S·ª≠ R√∫t L√¨ X√¨ (20 l·∫ßn g·∫ßn nh·∫•t)</h2>
      <table>
        <thead>
          <tr>
            <th>Ng∆∞·ªùi R√∫t</th>
            <th>üí∞ M·ªánh Gi√°</th>
            <th>üìÖ Th·ªùi Gian</th>
            <th>üéÆ Cheat?</th>
          </tr>
        </thead>
        <tbody id="bang-lich-su">
          <!-- S·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // =====================================================
    // ADMIN SCRIPT - Logic trang qu·∫£n l√Ω
    // =====================================================

    const API = '';

    // T·∫£i d·ªØ li·ªáu khi m·ªü trang
    document.addEventListener('DOMContentLoaded', () => {
      taiDanhSachMenhGia();
      taiThongKe();
      taiLichSu();
    });

    // =====================================================
    // T·∫¢I DANH S√ÅCH M·ªÜNH GI√Å - Hi·ªÉn th·ªã trong b·∫£ng
    // =====================================================
    async function taiDanhSachMenhGia() {
      try {
        const res = await fetch(`${API}/api/menh-gia`);
        const data = await res.json();

        if (data.thanh_cong) {
          const bang = document.getElementById('bang-menh-gia');

          // T√≠nh t·ªïng tr·ªçng s·ªë ƒë·ªÉ hi·ªÉn th·ªã t·ª∑ l·ªá %
          const tongTrongSo = data.du_lieu.reduce((t, item) => {
            return t + tinhTrongSo(item.menh_gia) * Math.min(item.so_luong, 10);
          }, 0);

          bang.innerHTML = data.du_lieu.map(item => {
            // T√≠nh t·ª∑ l·ªá % c·ªßa m·ªánh gi√° n√†y
            const trongSo = tinhTrongSo(item.menh_gia) * Math.min(item.so_luong, 10);
            const tyLe = ((trongSo / tongTrongSo) * 100).toFixed(1);

            // M√†u theo t·ª∑ l·ªá
            let mauTyLe = '#4CAF50'; // Xanh = cao
            if (tyLe < 5) mauTyLe = '#ff4444'; // ƒê·ªè = th·∫•p
            else if (tyLe < 15) mauTyLe = '#FFA500'; // Cam = trung b√¨nh

            return `
              <tr>
                <td>${item.id}</td>
                <td class="menh-gia-cell">${item.menh_gia.toLocaleString('vi-VN')}ƒë</td>
                <td>
                  <input type="number" value="${item.so_luong}" min="0" 
                    style="width:70px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,215,0,0.3); 
                    color:#fff; padding:5px; border-radius:5px; font-family:inherit;"
                    onchange="suaSoLuong(${item.id}, this.value)">
                </td>
                <td style="font-size:0.8em; color:rgba(255,255,255,0.5);">${item.ngay_tao || 'N/A'}</td>
                <td style="color:${mauTyLe}; font-weight:600;">${tyLe}%</td>
                <td>
                  <button class="btn btn-xoa" onclick="xoaMenhGia(${item.id})">üóëÔ∏è X√≥a</button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (err) {
        console.error('L·ªói t·∫£i m·ªánh gi√°:', err);
      }
    }

    // =====================================================
    // T√çNH TR·ªåNG S·ªê - Gi·ªëng server, d√πng ƒë·ªÉ hi·ªÉn th·ªã t·ª∑ l·ªá
    // =====================================================
    function tinhTrongSo(menh_gia) {
      if (menh_gia <= 200) return 100;
      if (menh_gia === 500) return 30;
      if (menh_gia === 1000) return 20;
      if (menh_gia === 2000) return 15;
      if (menh_gia === 5000) return 8;
      if (menh_gia === 10000) return 5;
      if (menh_gia === 20000) return 3;
      if (menh_gia === 50000) return 1.5;
      if (menh_gia >= 100000) return 0.5;
      return Math.max(0.1, 50 - (menh_gia / 100));
    }

    // =====================================================
    // T·∫¢I TH·ªêNG K√ä - Hi·ªÉn th·ªã s·ªë li·ªáu t·ªïng quan
    // =====================================================
    async function taiThongKe() {
      try {
        const res = await fetch(`${API}/api/thong-ke`);
        const data = await res.json();

        if (data.thanh_cong) {
          document.getElementById('stat-menh-gia').textContent = data.so_menh_gia;
          document.getElementById('stat-phong-bi').textContent = data.tong_phong_bi;
          document.getElementById('stat-tong-tien').textContent = data.tong_tien.toLocaleString('vi-VN');
        }
      } catch (err) {
        console.error('L·ªói t·∫£i th·ªëng k√™:', err);
      }
    }

    // =====================================================
    // T·∫¢I L·ªäCH S·ª¨ - Hi·ªÉn th·ªã l·ªãch s·ª≠ r√∫t l√¨ x√¨
    // =====================================================
    async function taiLichSu() {
      try {
        const res = await fetch(`${API}/api/lich-su`);
        const data = await res.json();

        if (data.thanh_cong) {
          const bang = document.getElementById('bang-lich-su');
          bang.innerHTML = data.du_lieu.map(item => `
            <tr>
              <td>${item.ten_nguoi}</td>
              <td class="menh-gia-cell">${item.menh_gia.toLocaleString('vi-VN')}ƒë</td>
              <td style="font-size:0.85em;">${item.thoi_gian}</td>
              <td>${item.la_cheat ? '‚≠ê C√≥' : '‚ùå Kh√¥ng'}</td>
            </tr>
          `).join('');
        }
      } catch (err) {
        console.error('L·ªói t·∫£i l·ªãch s·ª≠:', err);
      }
    }

    // =====================================================
    // TH√äM M·ªÜNH GI√Å M·ªöI
    // =====================================================
    async function themMenhGia() {
      const menh_gia = parseInt(document.getElementById('input-menh-gia').value);
      const so_luong = parseInt(document.getElementById('input-so-luong').value) || 1;

      // Ki·ªÉm tra d·ªØ li·ªáu
      if (isNaN(menh_gia) || menh_gia < 0) {
        hienThongBao('Vui l√≤ng nh·∫≠p m·ªánh gi√° h·ª£p l·ªá!', 'that-bai');
        return;
      }

      try {
        const res = await fetch(`${API}/api/menh-gia`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ menh_gia, so_luong })
        });
        const data = await res.json();

        if (data.thanh_cong) {
          hienThongBao(data.thong_diep, 'thanh-cong');
          // X√≥a input
          document.getElementById('input-menh-gia').value = '';
          document.getElementById('input-so-luong').value = '1';
          // T·∫£i l·∫°i danh s√°ch
          taiDanhSachMenhGia();
          taiThongKe();
        }
      } catch (err) {
        hienThongBao('L·ªói k·∫øt n·ªëi server!', 'that-bai');
      }
    }

    // Th√™m nhanh - cho n√∫t b·∫•m m·ªánh gi√° c√≥ s·∫µn
    function themNhanh(menh_gia, so_luong) {
      document.getElementById('input-menh-gia').value = menh_gia;
      document.getElementById('input-so-luong').value = so_luong;
      themMenhGia();
    }

    // =====================================================
    // X√ìA M·ªÜNH GI√Å
    // =====================================================
    async function xoaMenhGia(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ªánh gi√° n√†y?')) return;

      try {
        const res = await fetch(`${API}/api/menh-gia/${id}`, {
          method: 'DELETE'
        });
        const data = await res.json();

        if (data.thanh_cong) {
          hienThongBao('ƒê√£ x√≥a th√†nh c√¥ng!', 'thanh-cong');
          taiDanhSachMenhGia();
          taiThongKe();
        }
      } catch (err) {
        hienThongBao('L·ªói khi x√≥a!', 'that-bai');
      }
    }

    // =====================================================
    // S·ª¨A S·ªê L∆Ø·ª¢NG - Khi thay ƒë·ªïi input trong b·∫£ng
    // =====================================================
    async function suaSoLuong(id, so_luong) {
      try {
        await fetch(`${API}/api/menh-gia/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ so_luong: parseInt(so_luong) })
        });
        hienThongBao('ƒê√£ c·∫≠p nh·∫≠t!', 'thanh-cong');
        taiThongKe();
        // T·∫£i l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t t·ª∑ l·ªá %
        taiDanhSachMenhGia();
      } catch (err) {
        hienThongBao('L·ªói c·∫≠p nh·∫≠t!', 'that-bai');
      }
    }

    // =====================================================
    // HI·ªÇN TH·ªä TH√îNG B√ÅO - Popup g√≥c ph·∫£i tr√™n
    // =====================================================
    function hienThongBao(noiDung, loai) {
      const thongBao = document.createElement('div');
      thongBao.classList.add('thong-bao', loai);
      thongBao.textContent = noiDung;
      document.body.appendChild(thongBao);

      // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
      setTimeout(() => {
        thongBao.style.opacity = '0';
        thongBao.style.transition = 'opacity 0.3s';
        setTimeout(() => thongBao.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
